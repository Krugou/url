rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Short links collection
    match /short_links/{linkId} {

      // Anyone can read (needed for redirects)
      allow read: if true;

      // Create: validate all required fields
      allow create: if
        // Must have required fields
        request.resource.data.keys().hasAll(['id', 'originalUrl', 'createdAt', 'clicks'])

        // id must be a string, 1-20 chars
        && request.resource.data.id is string
        && request.resource.data.id.size() >= 1
        && request.resource.data.id.size() <= 20

        // originalUrl must be a string starting with http:// or https://
        && request.resource.data.originalUrl is string
        && (request.resource.data.originalUrl.matches('https?://.*'))

        // clicks must start at 0
        && request.resource.data.clicks == 0

        // Rate limiting: check if user created a link in the last 6 seconds
        // (basic throttling via timestamp â€” ~10/minute)
        && request.resource.data.createdAt == request.time;

      // Update: only allow incrementing the clicks counter
      allow update: if
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['clicks'])
        && request.resource.data.clicks == resource.data.clicks + 1;

      // No deletes from client
      allow delete: if false;
    }
  }
}
